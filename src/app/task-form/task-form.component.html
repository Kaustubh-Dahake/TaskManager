<p-toast position="top-center"></p-toast>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h2 class="mb-2">{{ isEdit ? 'Edit Task' : 'Create Task' }}</h2>
    <button type="button" pButton icon="pi pi-arrow-left" label="Back" class="p-button-secondary" (click)="goBack()"></button>
  </div>

  <form [formGroup]="taskForm" (ngSubmit)="onSubmit()" class="needs-validation" novalidate>
    <div class="row g-3">
      <div class="col-12">
        <label for="title" class="form-label">Title<span style="color: red;">*</span></label>
        <input pInputText formControlName="title" id="title" class="form-control" placeholder="Enter task title" />
        <small *ngIf="taskForm.controls['title'].invalid && taskForm.controls['title'].touched" class="text-danger">
          Title is required.
        </small>
      </div>

      <div class="col-12">
        <label for="description" class="form-label">Description<span style="color: red;">*</span></label>
        <textarea pInputTextarea formControlName="description" id="description" class="form-control" rows="4"
          placeholder="Optional description..."></textarea>
      </div>
      
      <div class="col-12 col-md-6">
        <label for="dueDate" class="form-label">Due Date<span style="color: red;">*</span></label>
        <p-calendar
          id="dueDate"
          formControlName="dueDate"
          dateFormat="yy-mm-dd"
          [showIcon]="true"
          inputId="dueDate"
        ></p-calendar>
      
        <small
          *ngIf="taskForm.controls['dueDate'].hasError('required') && taskForm.controls['dueDate'].touched"
          class="text-danger"
        >
          Due date is required.
        </small>
        <small
          *ngIf="taskForm.controls['dueDate'].hasError('pastDate') && taskForm.controls['dueDate'].touched"
          class="text-danger"
        >
          Due date cannot be in the past.
        </small>
      </div>
      
      <div class="col-12 col-md-6 d-flex align-items-center mt-3">
        <p-checkbox formControlName="isCompleted" inputId="isCompleted" [binary]="true"></p-checkbox>
        <label for="isCompleted" class="ms-2 mb-0">Mark as Completed</label>
      </div>
      <div *ngIf="isAdmin" class="col-12">
        <label for="assignedTo" class="form-label">Assign To<span style="color: red;">*</span></label>
        <p-dropdown formControlName="assignedTo"
                    [options]="users"
                    [placeholder]="'Select user'"
                    [filter]="true"
                    class="w-100">
        </p-dropdown>
        <small *ngIf="taskForm.controls['assignedTo'].invalid && taskForm.controls['assignedTo'].touched" class="text-danger">
          Assignment is required for Admin users.
        </small>
      </div>

      <div class="col-12 d-flex justify-content-between align-items-center flex-wrap mt-4 gap-2">
        <button type="submit"
                [disabled]="taskForm.invalid || isSaving"
                pButton
                label="{{ isEdit ? 'Update Task' : 'Create Task' }}"
                class="p-button-primary">
        </button>

        <button *ngIf="isEdit"
                type="button"
                pButton
                label="Delete"
                class="p-button-danger"
                icon="pi pi-trash"
                (click)="confirmDelete()">
        </button>
      </div>

    </div>
  </form>
</div>

<p-dialog header="Confirm Deletion"
          [(visible)]="displayDeleteDialog"
          [modal]="true"
          [closable]="false"
          [style]="{width: '100%', maxWidth: '400px'}">

  <p>Are you sure you want to delete this task?</p>

  <ng-template pTemplate="footer">
    <button type="button"
            pButton
            label="Cancel"
            icon="pi pi-times"
            (click)="closeDeleteDialog()"
            class="p-button-text">
    </button>
    <button type="button"
            pButton
            label="Delete"
            icon="pi pi-check"
            (click)="deleteTask()"
            class="p-button-danger">
    </button>
  </ng-template>
</p-dialog>
